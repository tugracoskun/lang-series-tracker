<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LangTracker - Season Mastery</title>

    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Outfit', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        glass: {
                            base: 'rgba(15, 23, 42, 0.6)',
                            border: 'rgba(255, 255, 255, 0.08)',
                            highlight: 'rgba(255, 255, 255, 0.05)',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-out forwards',
                        'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'scan': 'scan 2s linear infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(40px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        scan: { '0%': { transform: 'translateY(-100%)' }, '100%': { transform: 'translateY(100%)' } }
                    }
                }
            }
        }
    </script>

    <!-- 2. Scripts -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 3. Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Outfit:wght@500;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <style>
        body {
            background-color: #000;
            color: #e2e8f0;
            overflow-x: hidden;
        }

        .cinematic-bg {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            background-size: cover;
            background-position: center;
            transition: opacity 1s ease;
        }

        .cinematic-bg::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom,
                    rgba(0, 0, 0, 0.3) 0%,
                    rgba(0, 0, 0, 0.8) 50%,
                    #000 100%);
            backdrop-filter: blur(8px);
        }

        .glass-panel {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .scan-line {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(to right, transparent, #6366f1, transparent);
            opacity: 0.5;
            animation: scan 2s linear infinite;
        }

        /* Custom Scrollbar for Modal */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>

<body class="min-h-screen antialiased selection:bg-indigo-500/30 selection:text-indigo-200">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- SERVICES ---
        class TVMazeService {
            static BASE_URL = 'https://api.tvmaze.com';

            static async searchShows(query) {
                const res = await fetch(`${this.BASE_URL}/search/shows?q=${encodeURIComponent(query)}`);
                const data = await res.json();
                return data.map(item => item.show);
            }

            static async getShowDetails(id) {
                const res = await fetch(`${this.BASE_URL}/shows/${id}?embed=episodes`);
                return await res.json();
            }
        }

        // --- CONSTANTS ---
        const STORAGE_KEY = 'langTracker_v4_seasons';
        const METHODS = ['EN', 'TR', null]; // The rotation cycle

        // --- LOGIC ---

        const generateSeasonSchedule = (allEpisodes) => {
            const seasonsMap = {};
            allEpisodes.forEach(ep => {
                if (!seasonsMap[ep.season]) seasonsMap[ep.season] = [];
                seasonsMap[ep.season].push(ep);
            });

            const schedule = [];

            Object.keys(seasonsMap).sort((a, b) => a - b).forEach(seasonNum => {
                const episodes = seasonsMap[seasonNum];
                const tours = [];

                for (let t = 1; t <= 3; t++) {
                    const weeks = [];
                    let epCursor = 0;
                    let weekCounter = 1;

                    while (epCursor < episodes.length) {
                        const days = [];
                        for (let d = 0; d < 6; d++) {
                            if (epCursor < episodes.length) {
                                const ep = episodes[epCursor];
                                const methodIndex = (epCursor + (t - 1)) % 3;
                                const method = METHODS[methodIndex];

                                days.push({
                                    d: ["Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma", "Cumartesi"][d],
                                    epId: ep.id,
                                    epName: ep.name,
                                    season: ep.season,
                                    number: ep.number,
                                    l: method,
                                    airdate: ep.airdate,
                                    runtime: ep.runtime,
                                    summary: ep.summary, // Assuming summary is available in minimal object, otherwise we rely on detailed fetch or passed down data
                                    image: ep.image // Same for image
                                });
                                epCursor++;
                            }
                        }
                        days.push({ d: "Pazar", s: "Dinlenme & Analiz" });
                        weeks.push({ week: weekCounter, days });
                        weekCounter++;
                    }

                    tours.push({
                        id: t,
                        title: `${t}. Tur`,
                        pattern: t === 1 ? "EN → TR → Altyazısız" : t === 2 ? "TR → Altyazısız → EN" : "Altyazısız → EN → TR",
                        weeks
                    });
                }
                schedule.push({ season: parseInt(seasonNum), tours });
            });

            return schedule;
        };

        // --- COMPONENTS ---

        // 1. Cinematic Loader
        const CinematicLoader = ({ status }) => (
            <div className="fixed inset-0 z-[60] bg-black flex flex-col items-center justify-center font-mono">
                <div className="scan-line top-1/2"></div>
                <div className="text-2xl font-bold text-white mb-4 animate-pulse uppercase tracking-[0.2em]">
                    Sistem İnşa Ediliyor
                </div>
                <div className="text-xs text-indigo-400 max-w-xs text-center leading-relaxed opacity-80">
                    {status || "Nöral ağlar bağlanıyor..."}<br />
                    Rotasyon matrisi hesaplanıyor...<br />
                    Sezon verileri işleniyor...
                </div>
                <div className="mt-8 w-48 h-1 bg-gray-900 rounded-full overflow-hidden">
                    <div className="h-full bg-indigo-500 animate-[scan_1s_ease-in-out_infinite]"></div>
                </div>
            </div>
        );

        // 2. Add Series Modal
        const AddSeriesModal = ({ isOpen, onClose, onSelect }) => {
            const [query, setQuery] = useState("");
            const [results, setResults] = useState([]);
            const [searching, setSearching] = useState(false);

            useEffect(() => {
                const timer = setTimeout(async () => {
                    if (query.length > 2) {
                        setSearching(true);
                        try {
                            const shows = await TVMazeService.searchShows(query);
                            setResults(shows);
                        } catch (e) { console.error(e); }
                        setSearching(false);
                    }
                }, 500);
                return () => clearTimeout(timer);
            }, [query]);

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/90 backdrop-blur-xl animate-fade-in">
                    <div className="glass-panel w-full max-w-4xl h-[80vh] rounded-3xl p-8 relative flex flex-col overflow-hidden">
                        <button onClick={onClose} className="absolute top-6 right-6 text-slate-500 hover:text-white transition-colors">
                            <i data-lucide="x" width="32"></i>
                        </button>
                        <h2 className="text-3xl font-display font-bold text-white mb-2">Yeni Kayıt Başlat</h2>
                        <input
                            type="text"
                            className="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-4 text-white text-lg focus:ring-2 focus:ring-indigo-500 outline-none mb-8 placeholder:text-slate-600"
                            placeholder="Dizi adı girin (örn. Breaking Bad)..."
                            value={query}
                            onChange={e => setQuery(e.target.value)}
                            autoFocus
                        />
                        <div className="flex-1 overflow-y-auto grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 content-start pr-2 custom-scrollbar">
                            {searching && <div className="col-span-full text-center text-slate-500">Taranıyor...</div>}
                            {results.map(show => (
                                <div key={show.id} onClick={() => onSelect(show)}
                                    className="group relative aspect-[2/3] bg-slate-800 rounded-xl overflow-hidden cursor-pointer border border-transparent hover:border-indigo-500 transition-all hover:scale-[1.02]">
                                    {show.image?.medium ? (
                                        <img src={show.image.medium} className="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" />
                                    ) : (
                                        <div className="flex h-full items-center justify-center text-slate-600">Poster Yok</div>
                                    )}
                                    <div className="absolute inset-0 bg-gradient-to-t from-black/90 to-transparent flex items-end p-4">
                                        <h3 className="font-bold text-white text-sm">{show.name}</h3>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // 3. Episode Details Modal (Trakt Style)
        const EpisodeModal = ({ isOpen, onClose, episode, context, data, onToggle, onUpdateVocab }) => {
            const [word, setWord] = useState("");
            const [meaning, setMeaning] = useState("");

            if (!isOpen || !episode) return null;

            const vocabList = data.vocabulary?.[episode.id] || [];
            // Context ID is the unique ID for this day's task (e.g. s1-t1-d123)
            const isWatched = data.completed?.[context.id];

            const handleAddVocab = () => {
                if (!word.trim() || !meaning.trim()) return;
                const newVocab = [...vocabList, { id: Date.now(), word, meaning, date: new Date().toISOString() }];
                onUpdateVocab(episode.id, newVocab);
                setWord("");
                setMeaning("");
            };

            const removeVocab = (vocabId) => {
                const newVocab = vocabList.filter(v => v.id !== vocabId);
                onUpdateVocab(episode.id, newVocab);
            };

            const cleanSummary = episode.summary?.replace(/<[^>]*>?/gm, '') || "Özet bulunamadı.";

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 md:p-8 bg-black/80 backdrop-blur-md animate-fade-in" onClick={onClose}>
                    <div className="glass-panel w-full max-w-2xl max-h-[90vh] rounded-3xl relative flex flex-col overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>

                        {/* Header Image Area */}
                        <div className="relative h-48 md:h-64 flex-shrink-0">
                            {episode.image?.original ? (
                                <img src={episode.image.original} className="w-full h-full object-cover" />
                            ) : (
                                <div className="w-full h-full bg-slate-800 flex items-center justify-center text-slate-500">Görsel Yok</div>
                            )}
                            <div className="absolute inset-0 bg-gradient-to-t from-slate-900 to-transparent"></div>

                            <button onClick={onClose} className="absolute top-4 right-4 w-8 h-8 rounded-full bg-black/50 hover:bg-black/80 text-white flex items-center justify-center transition-colors backdrop-blur-sm">
                                <i data-lucide="x" width="18"></i>
                            </button>

                            <div className="absolute bottom-0 left-0 p-6 w-full">
                                <div className="flex items-center gap-3 mb-2">
                                    <span className="bg-indigo-500 px-2 py-0.5 rounded text-xs font-bold text-white shadow-lg shadow-indigo-500/20">
                                        {episode.season}x{episode.number < 10 ? '0' + episode.number : episode.number}
                                    </span>
                                    {episode.airdate && <span className="text-slate-300 text-xs font-mono">{episode.airdate.substring(0, 4)}</span>}
                                    {episode.runtime && <span className="text-slate-300 text-xs font-mono">{episode.runtime} dk</span>}
                                </div>
                                <h2 className="text-2xl md:text-3xl font-display font-bold text-white leading-tight shadow-black drop-shadow-lg">{episode.name}</h2>
                            </div>
                        </div>

                        {/* Content */}
                        <div className="flex-1 overflow-y-auto p-6 space-y-8 custom-scrollbar bg-[#0B0F17]">

                            {/* Action & Summary */}
                            <div className="flex flex-col md:flex-row gap-6">
                                <div className="flex-1">
                                    <p className="text-slate-300 leading-relaxed text-sm">{cleanSummary}</p>
                                </div>
                                <div className="flex-shrink-0 flex flex-col gap-3 min-w-[140px]">
                                    <button
                                        onClick={() => onToggle(context.id)}
                                        className={`flex items-center justify-center gap-2 px-4 py-3 rounded-xl font-bold transition-all shadow-lg ${isWatched ? 'bg-emerald-500 text-white shadow-emerald-500/20 hover:bg-emerald-600' : 'bg-slate-700 text-slate-200 hover:bg-slate-600'}`}>
                                        <i data-lucide={isWatched ? "check-circle-2" : "circle"} width="20"></i>
                                        {isWatched ? "İZLENDİ" : "İZLE"}
                                    </button>

                                    <div className="p-3 bg-white/5 rounded-xl border border-white/5 text-center">
                                        <div className="text-[10px] text-slate-400 font-mono mb-1 uppercase tracking-wider">İzleme Modu</div>
                                        <div className={`text-sm font-bold ${context.l === 'EN' ? 'text-blue-400' :
                                                context.l === 'TR' ? 'text-amber-400' : 'text-slate-200'
                                            }`}>
                                            {context.l ? `${context.l} ALTYAZI` : 'ALTYAZISIZ'}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Vocabulary Section */}
                            <div>
                                <div className="flex items-center gap-3 mb-4">
                                    <h3 className="text-lg font-bold text-white font-display">Kelime Defteri</h3>
                                    <span className="text-xs bg-white/10 px-2 py-0.5 rounded-full text-slate-400">{vocabList.length}</span>
                                </div>

                                <div className="bg-black/20 rounded-xl p-4 border border-white/5 mb-4">
                                    <div className="flex gap-2">
                                        <input
                                            className="flex-1 bg-transparent border-b border-slate-700 py-2 px-2 text-sm text-white focus:border-indigo-500 outline-none placeholder:text-slate-600 transition-colors"
                                            placeholder="Kelime (örn. Distinct)"
                                            value={word}
                                            onChange={e => setWord(e.target.value)}
                                        />
                                        <input
                                            className="flex-1 bg-transparent border-b border-slate-700 py-2 px-2 text-sm text-white focus:border-indigo-500 outline-none placeholder:text-slate-600 transition-colors"
                                            placeholder="Anlamı (örn. Belirgin)"
                                            value={meaning}
                                            onChange={e => setMeaning(e.target.value)}
                                            onKeyDown={e => e.key === 'Enter' && handleAddVocab()}
                                        />
                                        <button onClick={handleAddVocab} className="bg-indigo-500 hover:bg-indigo-600 text-white p-2 rounded-lg transition-colors">
                                            <i data-lucide="plus" width="18"></i>
                                        </button>
                                    </div>
                                </div>

                                <div className="space-y-2">
                                    {vocabList.map(v => (
                                        <div key={v.id} className="group flex items-center justify-between p-3 bg-white/5 rounded-lg border border-transparent hover:border-white/10 transition-colors">
                                            <div>
                                                <span className="font-bold text-indigo-300">{v.word}</span>
                                                <span className="mx-2 text-slate-600">•</span>
                                                <span className="text-slate-300">{v.meaning}</span>
                                            </div>
                                            <button onClick={() => removeVocab(v.id)} className="opacity-0 group-hover:opacity-100 p-1 text-rose-400 hover:bg-rose-500/10 rounded transition-all">
                                                <i data-lucide="trash" width="14"></i>
                                            </button>
                                        </div>
                                    ))}
                                    {vocabList.length === 0 && (
                                        <div className="text-center py-6 text-slate-600 text-sm border border-dashed border-slate-800 rounded-xl">
                                            Henüz kelime eklenmedi.
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Footer / Flashcard Placeholder */}
                        <div className="p-4 bg-black/40 border-t border-white/5 backdrop-blur flex justify-between items-center text-xs text-slate-500 font-mono">
                            <span>BÖLÜM ID: {episode.id}</span>
                            <div className="flex items-center gap-2 opacity-50 cursor-not-allowed">
                                <i data-lucide="lock" width="12"></i>
                                <span>FLASHCARDS (YAKINDA)</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 4. Series Detail (Updated)
        const SeriesDetail = ({ series, data, onBack, onUpdate }) => {
            const [expandedSeason, setExpandedSeason] = useState(series.schedule[0]?.season || 1);
            const [activeTour, setActiveTour] = useState(1);
            const [selectedEpisode, setSelectedEpisode] = useState(null);

            const totalSlots = series.schedule.reduce((acc, s) =>
                acc + s.tours.reduce((tAcc, t) =>
                    tAcc + t.weeks.reduce((wAcc, w) => wAcc + w.days.filter(d => d.epId).length, 0), 0), 0);

            const completedCount = Object.keys(data.completed || {}).length;
            const percentage = totalSlots > 0 ? Math.round((completedCount / totalSlots) * 100) : 0;

            const toggleDay = (dayId) => {
                const newCompleted = { ...(data.completed || {}) };
                if (newCompleted[dayId]) delete newCompleted[dayId];
                else newCompleted[dayId] = true;
                onUpdate(series.id, { completed: newCompleted });
            };

            const updateVocab = (epId, newVocabList) => {
                const newVocabulary = { ...(data.vocabulary || {}) };
                newVocabulary[epId] = newVocabList;
                onUpdate(series.id, { vocabulary: newVocabulary });
            };

            const openEpisode = (day, contextId) => {
                const fullEp = series.episodes.find(e => e.id === day.epId);
                setSelectedEpisode({
                    episode: fullEp,
                    context: { id: contextId, l: day.l }
                });
            };

            return (
                <div className="animate-fade-in pb-32 relative min-h-screen">
                    <EpisodeModal
                        isOpen={!!selectedEpisode}
                        onClose={() => setSelectedEpisode(null)}
                        episode={selectedEpisode?.episode}
                        context={selectedEpisode?.context}
                        data={data}
                        onToggle={toggleDay}
                        onUpdateVocab={updateVocab}
                    />

                    {/* Background */}
                    <div className="fixed inset-0 z-0">
                        {series.image?.original && (
                            <div className="absolute inset-0 bg-cover bg-center opacity-30 blur-3xl scale-110"
                                style={{ backgroundImage: `url(${series.image.original})` }}></div>
                        )}
                        <div className="absolute inset-0 bg-gradient-to-t from-black via-black/80 to-transparent"></div>
                    </div>

                    <div className="relative z-10">
                        {/* Header */}
                        <div className="sticky top-0 z-30 bg-[#000]/60 backdrop-blur-xl border-b border-white/5 shadow-2xl">
                            <div className="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
                                <div className="flex items-center gap-6">
                                    <button onClick={onBack} className="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center transition-colors">
                                        <i data-lucide="arrow-left" className="text-slate-200" width="20"></i>
                                    </button>
                                    <div>
                                        <h1 className="text-2xl font-display font-bold text-white tracking-tight">{series.name}</h1>
                                        <div className="flex items-center gap-3 text-xs font-mono text-indigo-300 mt-1">
                                            <span className="bg-indigo-500/10 px-2 py-0.5 rounded border border-indigo-500/20">{series.episodes.length} BÖLÜM</span>
                                            <span className="bg-emerald-500/10 px-2 py-0.5 rounded border border-emerald-500/20">{series.schedule.length} SEZON</span>
                                        </div>
                                    </div>
                                </div>
                                <div className="text-right">
                                    <div className="text-3xl font-bold text-white font-display mb-1">{percentage}%</div>
                                    <div className="w-32 h-1 bg-slate-800 rounded-full overflow-hidden">
                                        <div className="h-full bg-indigo-500 transition-all duration-1000" style={{ width: `${percentage}%` }}></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="max-w-6xl mx-auto px-6 py-10 space-y-6">
                            {series.schedule.map(seasonData => {
                                const isExpanded = expandedSeason === seasonData.season;
                                const currentTourData = seasonData.tours.find(t => t.id === activeTour);

                                const sTotal = seasonData.tours.reduce((acc, t) => acc + t.weeks.reduce((wa, w) => wa + w.days.filter(d => d.epId).length, 0), 0);
                                const sDone = seasonData.tours.reduce((acc, t) => acc + t.weeks.reduce((wa, w) => wa + w.days.reduce((da, d) => da + (d.epId && data.completed?.[`s${seasonData.season}-t${t.id}-d${d.epId}`] ? 1 : 0), 0), 0), 0);
                                const sPct = sTotal > 0 ? Math.round((sDone / sTotal) * 100) : 0;

                                return (
                                    <div key={seasonData.season} className={`glass-panel rounded-2xl overflow-hidden transition-all duration-500 ${isExpanded ? 'bg-slate-900/40 border-indigo-500/30' : 'hover:border-white/20'}`}>
                                        <button onClick={() => setExpandedSeason(isExpanded ? null : seasonData.season)} className="w-full flex items-center justify-between p-6 text-left group">
                                            <div className="flex items-center gap-6">
                                                <div className={`w-12 h-12 rounded-xl flex items-center justify-center font-bold text-lg transition-all duration-300 shadow-lg ${sPct === 100 ? 'bg-emerald-500 text-white' : 'bg-slate-800 text-slate-400'}`}>
                                                    {sPct === 100 ? <i data-lucide="check" width="24"></i> : seasonData.season}
                                                </div>
                                                <div>
                                                    <h3 className="text-xl font-bold text-white group-hover:text-indigo-300 transition-colors">{seasonData.season}. Sezon</h3>
                                                    <p className="text-sm text-slate-400 font-mono mt-1">{seasonData.tours[0].weeks.reduce((acc, w) => acc + w.days.filter(d => d.epId).length, 0)} Bölüm</p>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-6">
                                                <div className="text-xl font-bold font-display text-slate-500">{sPct}%</div>
                                                <i data-lucide="chevron-down" className={`text-slate-400 transition-transform ${isExpanded ? 'rotate-180' : ''}`}></i>
                                            </div>
                                        </button>

                                        {isExpanded && (
                                            <div className="border-t border-white/5 bg-black/20">
                                                <div className="flex border-b border-white/5">
                                                    {[1, 2, 3].map(tId => {
                                                        const tourObj = seasonData.tours.find(t => t.id === tId);
                                                        const tTotal = tourObj.weeks.reduce((acc, w) => acc + w.days.filter(d => d.epId).length, 0);
                                                        const tDone = tourObj.weeks.reduce((acc, w) => acc + w.days.filter(d => d.epId && data.completed?.[`s${seasonData.season}-t${tId}-d${d.epId}`]).length, 0);
                                                        const tPct = tTotal > 0 ? Math.round((tDone / tTotal) * 100) : 0;

                                                        return (
                                                            <button
                                                                key={tId}
                                                                onClick={() => setActiveTour(tId)}
                                                                className={`flex-1 py-4 text-sm font-medium transition-colors border-b-2 flex flex-col items-center gap-1 ${activeTour === tId ? 'text-white border-indigo-500 bg-white/5' : 'text-slate-500 border-transparent hover:text-slate-300'}`}>
                                                                <span>{tId}. TUR</span>
                                                                <span className="text-[10px] opacity-60 font-mono">{tPct}% {tId === 1 ? '(Başlangıç)' : tId === 2 ? '(Pekiştirme)' : '(Ustalık)'}</span>
                                                            </button>
                                                        )
                                                    })}
                                                </div>

                                                <div className="p-6 animate-fade-in">
                                                    <div className="mb-6 flex items-center gap-2 text-xs font-mono text-indigo-400 bg-indigo-500/10 p-3 rounded-lg border border-indigo-500/20 inline-block">
                                                        <i data-lucide="info" width="14"></i>
                                                        ROTASYON: {currentTourData.pattern}
                                                    </div>

                                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                                        {currentTourData.weeks.map(week => (
                                                            <div key={week.week} className="bg-white/5 rounded-xl p-4 border border-white/5">
                                                                <h4 className="text-xs font-bold text-slate-500 uppercase mb-3 px-1">HAFTA {week.week}</h4>
                                                                <div className="space-y-2">
                                                                    {week.days.map((day, dIdx) => {
                                                                        if (!day.epId) return null;
                                                                        const id = `s${seasonData.season}-t${activeTour}-d${day.epId}`;
                                                                        const isChecked = data.completed?.[id];
                                                                        const hasVocab = data.vocabulary?.[day.epId]?.length > 0;

                                                                        return (
                                                                            <div key={dIdx}
                                                                                onClick={() => openEpisode(day, id)}
                                                                                className={`group flex items-start gap-3 p-2.5 rounded-lg cursor-pointer transition-all border border-transparent ${isChecked ? 'bg-emerald-500/10 border-emerald-500/20' : 'hover:bg-white/10 hover:border-white/20 bg-black/20'}`}>

                                                                                <div onClick={(e) => { e.stopPropagation(); toggleDay(id); }}
                                                                                    className={`mt-1 w-4 h-4 rounded border flex-shrink-0 flex items-center justify-center transition-all cursor-pointer hover:border-emerald-400 ${isChecked ? 'bg-emerald-500 border-emerald-500' : 'border-slate-600'}`}>
                                                                                    {isChecked && <i data-lucide="check" width="10" className="text-white"></i>}
                                                                                </div>

                                                                                <div className="flex-1 min-w-0">
                                                                                    <div className={`text-xs font-medium truncate ${isChecked ? 'text-slate-500 line-through' : 'text-slate-200 group-hover:text-white'}`}>
                                                                                        {day.number}. {day.epName}
                                                                                    </div>
                                                                                    <div className="flex items-center gap-2 mt-1.5">
                                                                                        {day.l ? (
                                                                                            <span className={`text-[9px] font-bold px-1.5 py-px rounded uppercase tracking-wider ${day.l === 'EN' ? 'bg-blue-500/10 text-blue-400 border border-blue-500/20' :
                                                                                                    'bg-amber-500/10 text-amber-400 border border-amber-500/20'
                                                                                                }`}>
                                                                                                {day.l}
                                                                                            </span>
                                                                                        ) : (
                                                                                            <span className="text-[9px] font-bold px-1.5 py-px rounded uppercase tracking-wider bg-slate-500/10 text-slate-400 border border-slate-500/20">
                                                                                                ALTYAZISIZ
                                                                                            </span>
                                                                                        )}
                                                                                        {hasVocab && (
                                                                                            <span className="text-[9px] text-purple-400 bg-purple-500/10 px-1.5 py-px rounded border border-purple-500/20">
                                                                                                Kelime
                                                                                            </span>
                                                                                        )}
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        )
                                                                    })}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [db, setDb] = useState({ series: [], userData: {} });
            const [activeSeriesId, setActiveSeriesId] = useState(null);
            const [showAddModal, setShowAddModal] = useState(false);
            const [loadingState, setLoadingState] = useState(null);

            useEffect(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) setDb(JSON.parse(saved));
                lucide.createIcons();
            }, []);

            useEffect(() => {
                if (db.series.length > 0) localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
            }, [db]);

            useEffect(() => { lucide.createIcons(); });

            const handleSeriesSelect = async (show) => {
                setShowAddModal(false);
                setLoadingState("Veri bağlantısı kuruluyor...");
                try {
                    const details = await TVMazeService.getShowDetails(show.id);
                    if (!details._embedded?.episodes) throw new Error("Bölümler alınamadı.");

                    setLoadingState("Sezon matrisi oluşturuluyor...");
                    await new Promise(r => setTimeout(r, 1000));

                    const schedule = generateSeasonSchedule(details._embedded.episodes);

                    const newSeries = {
                        id: details.id.toString(),
                        name: details.name,
                        image: details.image,
                        episodes: details._embedded.episodes,
                        schedule: schedule
                    };

                    setDb(prev => ({
                        ...prev,
                        series: [newSeries, ...prev.series],
                        userData: { ...prev.userData, [newSeries.id]: { completed: {}, notes: {} } }
                    }));
                    setLoadingState(null);
                } catch (e) {
                    alert("Hata: " + e.message);
                    setLoadingState(null);
                }
            };

            const handleUpdate = (seriesId, newData) => {
                setDb(prev => ({
                    ...prev,
                    userData: { ...prev.userData, [seriesId]: { ...prev.userData[seriesId], ...newData } }
                }));
            };

            return (
                <div className="min-h-screen text-slate-200 font-sans">
                    {loadingState && <CinematicLoader status={loadingState} />}

                    {activeSeriesId ? (
                        <SeriesDetail
                            series={db.series.find(s => s.id === activeSeriesId)}
                            data={db.userData[activeSeriesId] || {}}
                            onBack={() => setActiveSeriesId(null)}
                            onUpdate={handleUpdate}
                        />
                    ) : (
                        <div className="max-w-7xl mx-auto px-6 py-12 animate-fade-in relative z-10">
                            <div className="cinematic-bg" style={{
                                backgroundImage: db.series[0]?.image?.original ? `url(${db.series[0].image.original})` : 'none',
                                opacity: 0.2
                            }}></div>

                            <header className="flex justify-between items-end mb-16">
                                <div>
                                    <h1 className="text-5xl md:text-6xl font-display font-bold text-white tracking-tighter">
                                        LANG<span className="text-transparent bg-clip-text bg-gradient-to-br from-indigo-400 to-purple-600">TRACKER</span>
                                    </h1>
                                    <p className="text-slate-400 mt-2 text-lg">Sezon Bazlı Rotasyon Protokolü</p>
                                </div>
                                <button onClick={() => setShowAddModal(true)} className="px-8 py-4 bg-white text-black font-bold text-lg rounded-full hover:scale-105 transition-transform flex items-center gap-2">
                                    <i data-lucide="plus" width="24"></i> YENİ GÖREV
                                </button>
                            </header>

                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                                {db.series.map(series => {
                                    const total = series.schedule.reduce((acc, s) => acc + s.tours.reduce((ta, t) => ta + t.weeks.reduce((wa, w) => wa + w.days.filter(d => d.epId).length, 0), 0), 0);
                                    const completed = Object.keys(db.userData[series.id]?.completed || {}).length;
                                    const pct = total > 0 ? Math.round((completed / total) * 100) : 0;
                                    return (
                                        <div key={series.id} onClick={() => setActiveSeriesId(series.id)}
                                            className="glass-panel rounded-3xl p-6 cursor-pointer hover:border-indigo-500/50 transition-all h-[400px] flex flex-col justify-end relative overflow-hidden group">
                                            {series.image?.original && (
                                                <div className="absolute inset-0">
                                                    <img src={series.image.original} className="w-full h-full object-cover opacity-50 group-hover:opacity-40 transition-opacity" />
                                                    <div className="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent"></div>
                                                </div>
                                            )}
                                            <div className="relative z-10">
                                                <h3 className="text-3xl font-display font-bold text-white mb-2">{series.name}</h3>
                                                <div className="h-1.5 bg-white/10 rounded-full overflow-hidden">
                                                    <div className="h-full bg-gradient-to-r from-indigo-500 to-purple-500" style={{ width: `${pct}%` }}></div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}
                    <AddSeriesModal isOpen={showAddModal} onClose={() => setShowAddModal(false)} onSelect={handleSeriesSelect} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>